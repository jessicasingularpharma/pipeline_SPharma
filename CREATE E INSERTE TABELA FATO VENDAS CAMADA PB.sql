CREATE TABLE IF NOT EXISTS pb.fato_Venda
(
    "CDFIL" VARCHAR(50),
    "DTOPE" DATE,
    "OPERID" VARCHAR(50) NOT NULL,
    "TPPAG" VARCHAR(50),
    "CDCON" VARCHAR(50),
    "CDFUN" VARCHAR(50),
    "CDCLI" VARCHAR(50),
    "CDCONRE" VARCHAR(50),
    "CDFUNRE" VARCHAR(50),
    "VRTOT" NUMERIC(10,2),
    "TPDSC" VARCHAR(50),
    "PTDSC" VARCHAR(50),
    "VRDSC" NUMERIC(10,2),
    "VRREC" NUMERIC(10,2),
    "VRRED" NUMERIC(10,2),
    "CDTXA" VARCHAR(50),
    "VRTXA" NUMERIC(10,2),
    "VRLIQ" NUMERIC(10,2),
    "VRTRC" NUMERIC(10,2),
    "QTTOT" NUMERIC(10,2),
    "VRCXA" NUMERIC(10,2),
    "VRRCB" NUMERIC(10,2),
    "CDSER" VARCHAR(50),
    "VRARC" NUMERIC(10,2),
    "NRPED" VARCHAR(50),
    "NRNF" VARCHAR(50),
    "NRPEDIDO" VARCHAR(50),
    "VTQUANT" NUMERIC(10,2),
    "VTESPECIE" VARCHAR(50),
    "VTMARCA" VARCHAR(50),
    "VTNUMERO" VARCHAR(50),
    "DTEMI" DATE,
    "DTSAI" DATE,
    "HRSAI" TIME WITHOUT TIME ZONE,
    "NRINSCRST" VARCHAR(50),
    "VRCTA" NUMERIC(10,2),
    "VRFRE" NUMERIC(10,2),
    "VRTOTIPI" NUMERIC(10,2),
    "VRTOTPROD" NUMERIC(10,2),
    "NRNFCE" VARCHAR(50),
    "STATUSENOTAS" VARCHAR(50),
    "CDTML" VARCHAR(50),
    "ITEMID" VARCHAR(50) NOT NULL,
    "CDFILR" VARCHAR(50),
    "CDPRO" INTEGER,
    "QUANT" NUMERIC(10,2),
    "PRUNI" NUMERIC(10,2),
    "VRDSCV" NUMERIC(10,2),
    "VRTXAV" NUMERIC(10,2),
    "CDIPI" VARCHAR(50),
    "PRCUSTO" NUMERIC(10,2),
    "PTLUCRO" NUMERIC(10,2),
    "DTPRESCR" DATE,
    "QTPRESCR" NUMERIC(10,2),
    "PRCOMPRA" NUMERIC(10,2),
    "PRUNILIQ" NUMERIC(10,2),
    CONSTRAINT pk_combined_vendas PRIMARY KEY ("OPERID", "ITEMID")
);


INSERT INTO pb.fato_Venda (
    "CDFIL", "DTOPE", "OPERID", "TPPAG", "CDCON", "CDFUN", "CDCLI", "CDCONRE", "CDFUNRE",
    "VRTOT", "TPDSC", "PTDSC", "VRDSC", "VRREC", "VRRED", "CDTXA", "VRTXA", "VRLIQ",
    "VRTRC", "QTTOT", "VRCXA", "VRRCB", "CDSER", "VRARC", "NRPED", "NRNF", "NRPEDIDO",
    "VTQUANT", "VTESPECIE", "VTMARCA", "VTNUMERO", "DTEMI", "DTSAI", "HRSAI", "NRINSCRST",
    "VRCTA", "VRFRE", "VRTOTIPI", "VRTOTPROD", "NRNFCE", "STATUSENOTAS", "CDTML", "ITEMID",
    "CDFILR", "CDPRO", "QUANT", "PRUNI", "VRDSCV", "VRTXAV", "CDIPI", "PRCUSTO", "PTLUCRO",
    "DTPRESCR", "QTPRESCR", "PRCOMPRA", "PRUNILIQ"
)
SELECT
    src."CDFIL",
    CAST(src."DTOPE" AS DATE),
    src."OPERID",
    src."TPPAG",
    src."CDCON",
    src."CDFUN",
    src."CDCLI",
    src."CDCONRE",
    src."CDFUNRE",
    CAST(src."VRTOT" AS NUMERIC(10, 2)),
    src."TPDSC",
    src."PTDSC",
    CAST(src."VRDSC" AS NUMERIC(10, 2)),
    CAST(src."VRREC" AS NUMERIC(10, 2)),
    CAST(src."VRRED" AS NUMERIC(10, 2)),
    src."CDTXA",
    CAST(src."VRTXA" AS NUMERIC(10, 2)),
    CAST(src."VRLIQ" AS NUMERIC(10, 2)),
    CAST(src."VRTRC" AS NUMERIC(10, 2)),
    CAST(src."QTTOT" AS NUMERIC(10, 2)),
    CAST(src."VRCXA" AS NUMERIC(10, 2)),
    CAST(src."VRRCB" AS NUMERIC(10, 2)),
    src."CDSER",
    CAST(src."VRARC" AS NUMERIC(10, 2)),
    src."NRPED",
    src."NRNF",
    src."NRPEDIDO",
    CAST(src."VTQUANT" AS NUMERIC(10, 2)),
    src."VTESPECIE",
    src."VTMARCA",
    src."VTNUMERO",
    CAST(src."DTEMI" AS DATE),
    CAST(src."DTSAI" AS DATE),
    CAST(src."HRSAI" AS TIME),
    src."NRINSCRST",
    CAST(src."VRCTA" AS NUMERIC(10, 2)),
    CAST(src."VRFRE" AS NUMERIC(10, 2)),
    CAST(src."VRTOTIPI" AS NUMERIC(10, 2)),
    CAST(src."VRTOTPROD" AS NUMERIC(10, 2)),
    src."NRNFCE",
    src."STATUSENOTAS",
    src."CDTML",  -- ADICIONE ESTA E OUTRAS QUE FALTAM
    src."ITEMID",
    src."CDFILR",
    src."CDPRO",
    CAST(src."QUANT" AS NUMERIC(10, 2)),
    CAST(src."PRUNI" AS NUMERIC(10, 2)),
    CAST(src."VRDSCV" AS NUMERIC(10, 2)),
    CAST(src."VRTXAV" AS NUMERIC(10, 2)),
    src."CDIPI",
    CAST(src."PRCUSTO" AS NUMERIC(10, 2)),
    CAST(src."PTLUCRO" AS NUMERIC(10, 2)),
    CAST(src."DTPRESCR" AS DATE),
    CAST(src."QTPRESCR" AS NUMERIC(10, 2)),
    CAST(src."PRCOMPRA" AS NUMERIC(10, 2)),
    CAST(src."PRUNILIQ" AS NUMERIC(10, 2))
FROM gold.combined_vendas src
WHERE NOT EXISTS (
    SELECT 1
    FROM pb.fato_Venda tgt
    WHERE tgt."CDFIL" = src."CDFIL"
      AND tgt."DTOPE" = CAST(src."DTOPE" AS DATE)
      AND tgt."OPERID" = src."OPERID"
);
